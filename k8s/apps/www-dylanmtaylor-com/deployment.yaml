apiVersion: apps/v1
kind: Deployment
metadata:
  name: www-dylanmtaylor-com
  namespace: dylanmtaylor
  labels:
    app: www-dylanmtaylor-com
spec:
  replicas: 2
  selector:
    matchLabels:
      app: www-dylanmtaylor-com
  template:
    metadata:
      labels:
        app: www-dylanmtaylor-com
    spec:
      securityContext:
        runAsNonRoot: true
        fsGroup: 65532  # nginx group - allows shared volume writes
        seccompProfile:
          type: RuntimeDefault
      automountServiceAccountToken: false
      imagePullSecrets:
        - name: dhi-registry
      initContainers:
        - name: copy-unzip
          image: dhi.io/awscli:2
          securityContext:
            runAsUser: 1001  # same as content-updater
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: r2-credentials
                  key: access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: r2-credentials
                  key: secret_access_key
          command: ['aws']
          args: ['s3', 'cp', 's3://dylanmtaylor-private-files/bin/unzip', '/tools/unzip', '--endpoint-url', 'https://24bed58f117be30c4a0c99a8511ad913.r2.cloudflarestorage.com']
          volumeMounts:
            - name: tools
              mountPath: /tools
      volumes:
        - name: website-content
          emptyDir: {}
        - name: tools
          emptyDir: {}
        - name: nginx-config
          configMap:
            name: www-dylanmtaylor-com-config
            items:
              - key: default.conf
                path: default.conf
      containers:
        - name: nginx
          image: dhi.io/nginx:1
          securityContext:
            runAsUser: 65532  # nginx user in DHI image
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
          ports:
            - containerPort: 8080
              name: http
          volumeMounts:
            - name: website-content
              mountPath: /data
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

        - name: content-updater
          image: docker.io/bitnami/git:latest
          securityContext:
            runAsUser: 1001  # bitnami git image user
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
          command: ["/bin/sh"]
          args:
            - -c
            - |
              #!/bin/sh
              set -e
              
              chmod +x /tools/unzip

              ARTIFACT_URL="https://gitlab.com/dylanmtaylor/dylanmtaylor.gitlab.io/-/jobs/artifacts/master/download?job=pages"
              LAST_COMMIT_FILE="/tmp/last_commit"

              # Function to update content
              update_content() {
                echo "$(date): Checking for updates..."
                
                # Get latest commit SHA from GitLab API
                LATEST_COMMIT=$(curl -s "https://gitlab.com/api/v4/projects/dylanmtaylor%2Fdylanmtaylor.gitlab.io/repository/commits/master" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p' || echo "")
                CURRENT_COMMIT=$(cat "$LAST_COMMIT_FILE" 2>/dev/null || echo "")
                
                # Check if content changed
                if [ "$CURRENT_COMMIT" = "$LATEST_COMMIT" ] && [ -n "$LATEST_COMMIT" ]; then
                  echo "$(date): No changes detected (commit: $(echo $LATEST_COMMIT | cut -c1-8)), skipping update"
                  return
                fi
                
                echo "$(date): New commit detected, updating content..."
                
                # Download and extract the site
                curl -Lo /tmp/site.zip "$ARTIFACT_URL"
                cd /tmp && /tools/unzip -o site.zip
                
                # Sync to shared volume (atomic via symlink rename)
                TIMESTAMP=$(date +%s)
                cp -r /tmp/public /data/content-$TIMESTAMP
                ln -sfn content-$TIMESTAMP /data/html-new
                mv /data/html-new /data/html
                # Cleanup old content dirs
                find /data -maxdepth 1 -name "content-*" ! -name "content-$TIMESTAMP" -exec rm -rf {} \;
                
                # Save new commit SHA
                echo "$LATEST_COMMIT" > "$LAST_COMMIT_FILE"
                
                echo "$(date): Content updated successfully"
              }

              # Initial update
              update_content

              # Check every 5 minutes
              while true; do
                sleep 300
                update_content
              done
          volumeMounts:
            - name: website-content
              mountPath: /data
            - name: tools
              mountPath: /tools
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
