apiVersion: apps/v1
kind: Deployment
metadata:
  name: www-dylanmtaylor-com
  namespace: dylanmtaylor
  labels:
    app: www-dylanmtaylor-com
spec:
  replicas: 2
  selector:
    matchLabels:
      app: www-dylanmtaylor-com
  template:
    metadata:
      labels:
        app: www-dylanmtaylor-com
    spec:
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      volumes:
        - name: website-content
          emptyDir: {}
      containers:
        - name: nginx-php-fpm
          image: docker.io/richarvey/nginx-php-fpm:3.1.6
          ports:
            - containerPort: 80
              name: http
          envFrom:
            - configMapRef:
                name: www-dylanmtaylor-com-config
          volumeMounts:
            - name: website-content
              mountPath: /var/www/html
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"

        - name: content-updater
          image: alpine:latest
          command: ["/bin/sh"]
          args:
            - -c
            - |
              #!/bin/sh
              set -e

              # Install required packages
              apk add --no-cache curl unzip rsync jq

              ARTIFACT_URL="https://gitlab.com/dylanmtaylor/dylanmtaylor.gitlab.io/-/jobs/artifacts/master/download?job=pages"
              LAST_COMMIT_FILE="/tmp/last_commit"

              # Function to update content
              update_content() {
                echo "$(date): Checking for updates..."
                
                # Get latest commit SHA from GitLab API
                LATEST_COMMIT=$(curl -s "https://gitlab.com/api/v4/projects/dylanmtaylor%2Fdylanmtaylor.gitlab.io/repository/commits/master" | jq -r '.id' 2>/dev/null || echo "")
                CURRENT_COMMIT=$(cat "$LAST_COMMIT_FILE" 2>/dev/null || echo "")
                
                # Check if content changed
                if [ "$CURRENT_COMMIT" = "$LATEST_COMMIT" ] && [ -n "$LATEST_COMMIT" ]; then
                  echo "$(date): No changes detected (commit: ${LATEST_COMMIT:0:8}), skipping update"
                  return
                fi
                
                echo "$(date): New commit detected (${LATEST_COMMIT:0:8}), updating content..."
                
                # Download and extract the site
                curl -Lo /tmp/site.zip "$ARTIFACT_URL"
                rm -rf /tmp/site
                unzip -q /tmp/site.zip -d /tmp/site
                
                # Sync to shared volume
                rsync -rh /tmp/site/public/ /var/www/html/ --delete
                
                # Save new commit SHA
                echo "$LATEST_COMMIT" > "$LAST_COMMIT_FILE"
                
                echo "$(date): Content updated successfully"
              }

              # Initial update
              update_content

              # Check every 5 minutes
              while true; do
                sleep 300
                update_content
              done
          volumeMounts:
            - name: website-content
              mountPath: /var/www/html
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
