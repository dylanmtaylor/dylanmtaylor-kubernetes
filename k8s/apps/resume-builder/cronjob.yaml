apiVersion: batch/v1
kind: CronJob
metadata:
  name: resume-builder
  namespace: dylanmtaylor
  labels:
    app: resume-builder
spec:
  # Run every 15 minutes
  schedule: "*/15 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: resume-builder
        spec:
          restartPolicy: OnFailure
          serviceAccountName: resume-builder
          containers:
            - name: builder
              image: ghcr.io/dylanmtaylor/resume-builder:latest
              command: ["/bin/bash"]
              args:
                - -c
                - |
                  #!/bin/bash
                  set -e

                  echo "$(date): Starting resume build process..."

                  # Fetch R2 credentials from OCI Vault using instance principal
                  echo "Fetching R2 credentials from OCI Vault..."
                  COMPARTMENT_ID="ocid1.tenancy.oc1..aaaaaaaapryt5njqmdf6nt5n4q7kj7cjgqbivfkcho6rxlh4prbn4wvlppaq"
                  VAULT_OCID=$(/opt/venv/bin/oci kms management vault list \
                    --auth instance_principal \
                    --compartment-id "$COMPARTMENT_ID" \
                    --query "data[?\"display-name\"=='dylanmtaylor'].id | [0]" --raw-output)
                  SECRET_OCID=$(/opt/venv/bin/oci vault secret list \
                    --auth instance_principal \
                    --compartment-id "$COMPARTMENT_ID" \
                    --vault-id "$VAULT_OCID" \
                    --name r2-credentials \
                    --lifecycle-state ACTIVE \
                    --query 'data[0].id' --raw-output)
                  CREDS=$(/opt/venv/bin/oci secrets secret-bundle get \
                    --auth instance_principal \
                    --secret-id "$SECRET_OCID" \
                    --query 'data."secret-bundle-content".content' --raw-output | base64 -d)
                  export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r '.access_key_id')
                  export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r '.secret_access_key')
                  CF_ACCOUNT_ID=$(echo "$CREDS" | jq -r '.account_id')

                  # Clone the resume repository
                  echo "Cloning resume repository..."
                  rm -rf /tmp/resume
                  git clone https://gitlab.com/dylanmtaylor/Dylan-Resume.git /tmp/resume
                  cd /tmp/resume

                  # Build the resume PDF
                  echo "Building resume PDF with XeLaTeX..."
                  mkdir -p /tmp/output
                  xelatex --output-directory=/tmp/output /tmp/resume/dylan-resume.tex

                  # Run again for references (LaTeX typically needs 2 passes)
                  xelatex --output-directory=/tmp/output /tmp/resume/dylan-resume.tex

                  # Check if PDF was created
                  if [ ! -f /tmp/output/dylan-resume.pdf ]; then
                    echo "ERROR: PDF was not generated!"
                    exit 1
                  fi

                  echo "Resume built successfully: $(ls -lh /tmp/output/dylan-resume.pdf)"

                  # Upload to Cloudflare R2
                  echo "Uploading to Cloudflare R2..."
                  aws s3 cp /tmp/output/dylan-resume.pdf \
                    s3://dylanmtaylor-public-files/dylan-resume.pdf \
                    --endpoint-url "https://${CF_ACCOUNT_ID}.r2.cloudflarestorage.com"

                  echo "$(date): Resume uploaded successfully!"
              resources:
                requests:
                  memory: "256Mi"
                limits:
                  memory: "2Gi"
