apiVersion: batch/v1
kind: CronJob
metadata:
  name: resume-builder
  namespace: dylanmtaylor
  labels:
    app: resume-builder
spec:
  # Run every hour
  schedule: "0 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: resume-builder
        spec:
          restartPolicy: OnFailure
          serviceAccountName: resume-builder
          containers:
            - name: builder
              image: ghcr.io/dylanmtaylor/resume-builder:latest
              command: ["/bin/bash"]
              args:
                - -c
                - |
                  #!/bin/bash
                  set -e

                  echo "$(date): Starting resume build process..."

                  # Clone the resume repository
                  echo "Cloning resume repository..."
                  rm -rf /tmp/resume
                  git clone https://gitlab.com/dylanmtaylor/Dylan-Resume.git /tmp/resume
                  cd /tmp/resume

                  # Build the resume PDF
                  echo "Building resume PDF with XeLaTeX..."
                  mkdir -p /tmp/output
                  xelatex --output-directory=/tmp/output /tmp/resume/dylan-resume.tex

                  # Run again for references (LaTeX typically needs 2 passes)
                  xelatex --output-directory=/tmp/output /tmp/resume/dylan-resume.tex

                  # Check if PDF was created
                  if [ ! -f /tmp/output/dylan-resume.pdf ]; then
                    echo "ERROR: PDF was not generated!"
                    exit 1
                  fi

                  echo "Resume built successfully: $(ls -lh /tmp/output/dylan-resume.pdf)"

                  # Upload to OCI Object Storage
                  echo "Uploading to OCI Object Storage..."

                  # Debug: Check what authentication is available
                  echo "Testing OCI authentication..."
                  /opt/venv/bin/oci iam region list --auth instance_principal || echo "Instance principal auth failed"

                  # Get namespace
                  echo "Getting OCI namespace..."
                  NAMESPACE=$(/opt/venv/bin/oci os ns get --auth instance_principal --query data --raw-output)
                  echo "Namespace: $NAMESPACE"

                  # List buckets to verify access
                  echo "Listing accessible buckets..."
                  /opt/venv/bin/oci os bucket list --namespace-name "$NAMESPACE" --compartment-id "$(echo $OCI_RESOURCE_PRINCIPAL_RPT | base64 -d | jq -r '.res_tenant' 2>/dev/null || echo 'unknown')" --auth instance_principal || echo "Failed to list buckets"

                  # Try to get bucket details
                  echo "Checking if bucket exists..."
                  /opt/venv/bin/oci os bucket get \
                    --namespace-name "$NAMESPACE" \
                    --bucket-name dylanmtaylor_public_files \
                    --auth instance_principal || echo "Bucket not found or no access"

                  # Upload the file
                  echo "Attempting upload..."
                  /opt/venv/bin/oci os object put \
                    --namespace-name "$NAMESPACE" \
                    --bucket-name dylanmtaylor_public_files \
                    --file /tmp/output/dylan-resume.pdf \
                    --name dylan-resume.pdf \
                    --force \
                    --auth instance_principal

                  echo "$(date): Resume uploaded successfully!"
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "500m"
                limits:
                  memory: "2Gi"
                  cpu: "1000m"
